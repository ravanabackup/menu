<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Railway Food Menu - IRCTC (CORS Proxy Applied)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Montserrat:wght=800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        /* --- Material You / Expressive Theme Variables (Simulated) --- */
        :root {
            /* Primary Color: Deep Purple / Indigo */
            --hue-primary: 260; 
            --color-primary: hsl(var(--hue-primary), 70%, 55%); 
            --color-on-primary: #ffffff;
            --color-surface-bg: #f8f6fb;
            --color-surface-container-high: #ffffff; 
            --color-surface-container: #ede7f6;
            --color-on-surface: #1d1b20;
            --color-secondary-container: hsl(var(--hue-primary), 60%, 90%);
            --color-on-secondary-container: #494551;
            --color-outline: #7a7585;
            --color-error: #ba1a1a;
            --color-price: #388e3c; 
            --color-online: #4CAF50;
            --border-radius-xl: 36px;
            --border-radius-l: 16px;
            --elevation-low: 0 4px 10px rgba(0, 0, 0, 0.05);
            --elevation-mid: 0 8px 18px rgba(0, 0, 0, 0.1);
        }

        /* Dark Theme Palette (Simulated) */        
        body.dark-mode {
            --color-primary: hsl(var(--hue-primary), 70%, 75%);
            --color-on-primary: #381e72;
            --color-surface-bg: #110e14;
            --color-surface-container-high: #1d1b20;
            --color-surface-container: #26242c;
            --color-on-surface: #e6e1e5;
            --color-secondary-container: #443c52;
            --color-on-secondary-container: #e8def8;
            --color-outline: #948f99;
            --color-error: #ffb4ab;
            --color-price: #a5d6a7; 
            --color-online: #81c784;
            --elevation-low: 0 2px 5px rgba(0, 0, 0, 0.5);
            --elevation-mid: 0 5px 12px rgba(0, 0, 0, 0.6);
        }

        /* --- Global Styles --- */        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--color-surface-bg);
            color: var(--color-on-surface);
            min-height: 100vh;
            padding: 24px;
            transition: background-color 0.4s ease-in-out, color 0.4s ease-in-out;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: var(--color-surface-container-high);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--elevation-mid);
            overflow: hidden;
        }

        /* --- Header Section --- */        
        .header {
            background-color: var(--color-primary);
            color: var(--color-on-primary);
            padding: 50px 24px 30px; 
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5em;
            margin-bottom: 8px;
            font-weight: 800;
            letter-spacing: -1px; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .status-icon {
            font-size: 1.2em;
            vertical-align: middle;
            transition: color 0.3s ease;
            display: inline-flex;
            line-height: 1; 
        }

        .status-icon.online { color: var(--color-online); }
        .status-icon.error { color: var(--color-error); animation: pulse-red 1.2s infinite alternate; }

        @keyframes pulse-red {
            from { opacity: 0.7; transform: scale(1.0); }
            to { opacity: 1; transform: scale(1.2); }
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--color-surface-container-high);
            color: var(--color-primary);
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.4em;
            box-shadow: var(--elevation-low);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Tabs --- */        
        .tabs {
            display: flex;
            padding: 16px 24px;
            gap: 12px;
            background-color: var(--color-surface-container-high);
            border-bottom: 1px solid var(--color-outline);
            flex-wrap: wrap; 
        }

        .tab {
            flex: 1;
            min-width: 120px; 
            padding: 14px 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            color: var(--color-on-surface);
            border: 1px solid var(--color-outline);
            background-color: transparent;
            border-radius: var(--border-radius-l);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab.active {
            background-color: var(--color-primary);
            color: var(--color-on-primary);
            border-color: var(--color-primary);
            box-shadow: var(--elevation-low);
        }

        /* --- Content Area --- */        
        .content {
            padding: 32px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* --- Last Modified/Header Info Box (Critical) --- */
        .header-info {
            background-color: var(--color-secondary-container);
            color: var(--color-on-secondary-container);
            padding: 12px 20px;
            border-radius: var(--border-radius-l);
            margin-bottom: 24px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--elevation-low);
            border: 1px solid transparent; 
        }

        .header-info.error-state {
            background-color: #fce8e6; 
            color: var(--color-error);
            border: 1px solid var(--color-error);
        }

        body.dark-mode .header-info.error-state {
            background-color: #3b000a;
        }

        .header-info.error-state .material-icons {
            color: var(--color-error);
        }
        
        .header-info .material-icons {
            font-size: 1.4em;
            color: var(--color-primary);
        }
        
        .header-info strong {
            font-weight: 500;
            white-space: nowrap;
        }

        /* --- Menu Sections & Tables --- */        
        .menu-section {
            margin-bottom: 32px;
            padding: 24px;
            background-color: var(--color-surface-container);
            border-radius: var(--border-radius-l);
            box-shadow: var(--elevation-low);
        }

        .section-title {
            color: var(--color-primary);
            padding-bottom: 12px;
            margin-bottom: 20px;
            font-size: 1.6em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid var(--color-secondary-container);
        }

        .menu-table {
            width: 100%;
            border-collapse: collapse;
        }

        .menu-table th {
            padding: 12px 8px;
            font-weight: 500;
            text-align: left;
            opacity: 0.8;
            font-size: 0.9em;
        }
        
        .menu-table th:nth-child(3),
        .menu-table th:nth-child(4),
        .menu-table td:nth-child(3),
        .menu-table td:nth-child(4) {
            text-align: right;
        }
        
        .menu-table.snack-table th:nth-child(3) { text-align: left; }
        .menu-table.snack-table th:nth-child(4) { display: none; }
        .menu-table.snack-table td:nth-child(3) { text-align: left; }
        .menu-table.snack-table td:nth-child(4) { text-align: right; }
        .menu-table.snack-table .hide-on-snack { display: none; }

        .menu-table td {
            padding: 16px 8px;
            vertical-align: middle;
            border-bottom: 1px solid rgba(122, 117, 133, 0.15); 
        }
        
        .price {
            font-size: 1.1em;
            color: var(--color-price);
            font-weight: 700;
            white-space: nowrap;
        }
        
        .note {
            background-color: var(--color-primary);
            color: var(--color-on-primary);
            padding: 20px;
            border-radius: var(--border-radius-l);
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--elevation-low);
        }

        .loading, .error {
            padding: 20px;
            border-radius: var(--border-radius-l);
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--elevation-low);
        }
        .loading { justify-content: center; background-color: var(--color-secondary-container); color: var(--color-primary); }
        .error { background-color: #fce8e6; color: var(--color-error); border-left: 4px solid var(--color-error); }
        body.dark-mode .error { background-color: #3b000a; color: var(--color-error); }

        /* --- Media Queries (Mobile View) --- */        
        @media (max-width: 600px) {
            .tabs { flex-direction: column; }
            .menu-table.snack-table td:nth-child(3) { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle Theme">
                <i class="material-icons" id="theme-icon">dark_mode</i>
            </button>
            <h1>
                <i class="fa fa-train"></i> IRCTC E-Catering
                <span class="status-icon" id="beverages-status-icon" title="Beverages Status">‚òï</span>
                <span class="status-icon" id="breakfast-status-icon" title="Breakfast Status">üç≥</span>
                <span class="status-icon" id="meals-status-icon" title="Meals Status">ü•ó</span>
                <span class="status-icon" id="snackmeals-status-icon" title="Snack Meals Status">ü•™</span>
            </h1>
            <p>Official Standard Menu Rates (Inclusive of All Taxes)</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab(event, 'beverages')"><span>‚òï</span> Beverages</button>
            <button class="tab" onclick="showTab(event, 'breakfast')"><span>üç≥</span> Breakfast</button>
            <button class="tab" onclick="showTab(event, 'meals')"><span>ü•ó</span> Meals</button>
            <button class="tab" onclick="showTab(event, 'snackmeals')"><span>ü•™</span> Snack Meals</button>
        </div>

        <div class="content">
            <div id="beverages" class="tab-content active">
                <div class="loading"><i class="fa fa-spinner fa-spin"></i> Loading beverages menu...</div>
            </div>
            <div id="breakfast" class="tab-content">
                <div class="loading"><i class="fa fa-spinner fa-spin"></i> Loading breakfast menu...</div>
            </div>
            <div id="meals" class="tab-content">
                <div class="loading"><i class="fa fa-spinner fa-spin"></i> Loading meals menu...</div>
            </div>
            <div id="snackmeals" class="tab-content">
                <div class="loading"><i class="fa fa-spinner fa-spin"></i> Loading snack meals menu...</div>
            </div>
        </div>
    </div>
    <script>
        // --- Configuration ---
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        const BEVERAGES_URL = 'https://menurates.irctc.co.in/standared_beverages.html';
        const MEALS_URL = 'https://menurates.irctc.co.in/standared_meal.html';
        const BREAKFAST_URL = 'https://menurates.irctc.co.in/standared_breakfast.html';
        const SNACKMEALS_URL = 'https://menurates.irctc.co.in/snackMeals.html';

        /**
         * Converts a GMT date string to Indian Standard Time (IST) format.
         */
        function convertGMTtoIST(gmtDateString) {
            if (!gmtDateString) return 'Date not available';
            try {
                const date = new Date(gmtDateString);
                if (isNaN(date.getTime())) return 'Invalid Date Format';
                const istString = date.toLocaleString('en-IN', {
                    timeZone: 'Asia/Kolkata',
                    weekday: 'short', year: 'numeric', month: 'short', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                });
                return `${istString} IST`;
            } catch (error) {
                return 'Conversion Error';
            }
        }
        
        /**
         * Fetches the Last-Modified header using a CORS proxy.
         * Acknowledges that the proxy might strip the actual header and provides fallback information.
         */
        async function fetchLastModifiedHeader(url) {
            try {
                // Using the CORS proxy URL
                const response = await fetch(CORS_PROXY + encodeURIComponent(url), {
                    method: 'GET'
                });

                if (!response.ok) {
                    return { lastModified: 'Failed to fetch header (Network error or IRCTC down)', isError: true };
                }
                
                // 1. Try to get the standard Last-Modified header (often stripped by proxy)
                let gmtDate = response.headers.get('Last-Modified');
                
                // 2. Use the Proxy's response Date header as fallback timestamp
                const proxyDate = response.headers.get('Date');

                if (gmtDate) {
                    // Success: Header was relayed properly
                    return { lastModified: convertGMTtoIST(gmtDate), isError: false };
                }
                
                // Failure: Header was stripped by the proxy (common issue)
                return { 
                    lastModified: `Header not available. Proxy Response Date: ${proxyDate ? convertGMTtoIST(proxyDate) : 'Unknown Date'} (Original Last-Modified header stripped by CORS Proxy)`, 
                    isError: true 
                };

            } catch (error) {
                return { lastModified: 'Failed to fetch header (Client-side error)', isError: true };
            }
        }

        // --- Data Parsing & Generation ---

        /**
         * Fetches and parses the menu content.
         */
        async function fetchMenuData(url) {
            try {
                // *** Using Proxy for Content ***
                const response = await fetch(CORS_PROXY + encodeURIComponent(url));
                if (!response.ok) throw new Error('Failed to fetch data');
                const html = await response.text();
                return parseMenuData(html, url); 
            } catch (error) {
                return null;
            }
        }

        /**
         * Parses the menu data from the IRCTC HTML structure.
         */
        function parseMenuData(htmlString, url) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const menuData = {};
            let currentCategory = null;
            const isSnackMeal = url.includes('snackMeals.html'); 

            const mainTable = doc.querySelector('table.listmenu, table.tablewhites, table');
            if (!mainTable) return menuData;

            const rows = mainTable.querySelectorAll('tr');

            rows.forEach(row => {
                const categoryHeader = row.querySelector('td[colspan]');
                if (categoryHeader && categoryHeader.querySelector('h3')) {
                    const categoryName = categoryHeader.querySelector('h3').textContent.trim();
                    if (categoryName.includes('Humsafar') || categoryName.includes('AVM Machine')) { currentCategory = null; return; }
                    currentCategory = categoryName || (isSnackMeal ? 'Snack Meals' : null);
                    if (!menuData[currentCategory]) { menuData[currentCategory] = []; } return;
                }

                if (currentCategory === null) return;

                const cells = row.querySelectorAll('td');

                if ((isSnackMeal && cells.length === 4) || (!isSnackMeal && cells.length >= 4)) {
                    const itemText = cells[1] ? cells[1].textContent.trim() : '';
                    if (!itemText || itemText.toLowerCase().includes('item') || itemText === '') return;

                    const cleanPrice = (text) => {
                        if (text === 'N/A' || text === '-') return 'N/A';
                        const price = parseFloat(text.replace(/[^\d.]/g, ''));
                        return isNaN(price) ? text : Math.round(price);
                    };

                    if (isSnackMeal) {
                        menuData[currentCategory].push({
                            item: itemText,
                            particulars: cells[2] ? cells[2].textContent.trim() : '',
                            veg: true,
                            singleRate: cleanPrice(cells[3] ? cells[3].textContent.trim() : '')
                        });
                    } else {
                        const img = cells[0].querySelector('img');
                        const isVeg = img ? (img.src.includes('veg.png') && !img.src.includes('non-veg.png')) : true;

                        menuData[currentCategory].push({
                            item: itemText,
                            veg: isVeg,
                            atStation: cleanPrice(cells[cells.length - 2].textContent.trim()),
                            inTrain: cleanPrice(cells[cells.length - 1].textContent.trim())
                        });
                    }
                }
            });

            return menuData;
        }

        /**
         * Creates the header info box with date and status.
         */
        function createHeaderInfoBox(headerInfo) {
            const icon = headerInfo.isError ? 'warning' : 'history';
            const className = headerInfo.isError ? 'header-info error-state' : 'header-info';
            
            return `
                <div class="${className}">
                    <i class="material-icons">${icon}</i>
                    <strong>Source Last Updated (IST):</strong> 
                    <span id="last-modified-ist">${headerInfo.lastModified}</span>
                </div>
            `;
        }
        
        /**
         * Generates the HTML table structure for the menu.
         */
        function createMenuTable(data, tabName) {
            let html = '';
            const isSnackMeal = tabName === 'snackmeals';
            const tableClass = isSnackMeal ? 'menu-table snack-table' : 'menu-table';
            let noteHtml = '';

            // Generate tab-specific notes
            if (tabName === 'beverages') {
                noteHtml = `<div class="note"><strong><i class="material-icons">info</i> Important Note:</strong> All displayed prices are officially inclusive of taxes (GST). Always check with the railway staff for the latest rates on board.</div>`;
            } else if (tabName === 'meals') {
                noteHtml = `<div class="note"><strong><i class="material-icons">info</i> Important Note:</strong> All displayed prices are officially inclusive of taxes (GST). Menu items and prices may vary based on train type (e.g., Rajdhani, Shatabdi).</div>`;
            } else if (tabName === 'breakfast' || tabName === 'snackmeals') {
                noteHtml = `<div class="note"><strong><i class="material-icons">info</i> Important Note:</strong> All displayed prices are officially inclusive of taxes (GST). Check availability for specific items in your train.</div>`;
            }

            for (const [category, items] of Object.entries(data)) {
                if (items.length === 0) continue;

                let categoryIcon = 'restaurant';
                if (category.toLowerCase().includes('tea') || category.toLowerCase().includes('coffee')) { categoryIcon = 'emoji_food_beverage'; } 
                else if (category.toLowerCase().includes('meal') || category.toLowerCase().includes('main')) { categoryIcon = 'set_meal'; } 
                else if (category.toLowerCase().includes('break')) { categoryIcon = 'ramen_dining'; } 
                else if (category.toLowerCase().includes('snack')) { categoryIcon = 'fastfood'; }
                
                html += `
                    <div class="menu-section">
                        <div class="section-title"><i class="material-icons">${categoryIcon}</i> ${category}</div>
                        <table class="${tableClass}">
                            <thead>
                                <tr>
                                    <th style="width: 5%"></th>
                                    <th style="width: ${isSnackMeal ? '30%' : '35%'}">Item</th>
                                    <th style="width: ${isSnackMeal ? '45%' : '20%'}; text-align: ${isSnackMeal ? 'left' : 'right'};">${isSnackMeal ? 'Particulars' : 'At Station'}</th>
                                    <th style="width: 20%; text-align: right;" class="${isSnackMeal ? 'hide-on-snack' : ''}">${isSnackMeal ? 'Rate' : 'In Train'}</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                items.forEach(item => {
                    const icon = item.veg
                        ? 'https://menurates.irctc.co.in/images/veg.png'
                        : 'https://menurates.irctc.co.in/images/non-veg.png';

                    const formatPrice = (price) => {
                        if (price === "N/A" || typeof price !== 'number') return price;
                        return `<i class="fa fa-rupee"></i> ${price.toFixed(0)}`;
                    };
                    
                    if (isSnackMeal) {
                         html += `
                            <tr>
                                <td><img src="${icon}" alt="${item.veg ? 'Veg' : 'Non-Veg'}" class="${item.veg ? 'veg-icon' : 'non-veg-icon'}"></td>
                                <td class="item-name">${item.item}</td>
                                <td class="item-particulars">${item.particulars}</td>
                                <td class="price">${formatPrice(item.singleRate)}</td>
                            </tr>
                        `;
                    } else {
                        html += `
                            <tr>
                                <td><img src="${icon}" alt="${item.veg ? 'Veg' : 'Non-Veg'}" class="${item.veg ? 'veg-icon' : 'non-veg-icon'}"></td>
                                <td class="item-name">${item.item}</td>
                                <td class="price">${formatPrice(item.atStation)}</td>
                                <td class="price">${formatPrice(item.inTrain)}</td>
                            </tr>
                        `;
                    }
                });

                html += `</tbody></table></div>`;
            }

            return html + noteHtml; 
        }

        // --- UI & Theme Logic ---
        function showTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            themeIcon.textContent = isDarkMode ? 'light_mode' : 'dark_mode';
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            if (savedTheme === 'dark') {
                body.classList.add('dark-mode');
                themeIcon.textContent = 'light_mode';
            } else {
                themeIcon.textContent = 'dark_mode';
            }
        }
        
        function updateStatusIcon(id, isOnline) {
            const iconElement = document.getElementById(id);
            if (iconElement) {
                iconElement.classList.remove('online', 'error');
                iconElement.classList.add(isOnline ? 'online' : 'error');
            }
        }

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', async () => {
            loadTheme();

            const tabs = [
                { id: 'beverages', url: BEVERAGES_URL, statusId: 'beverages-status-icon', name: 'beverages' },
                { id: 'breakfast', url: BREAKFAST_URL, statusId: 'breakfast-status-icon', name: 'breakfast' },
                { id: 'meals', url: MEALS_URL, statusId: 'meals-status-icon', name: 'meals' },
                { id: 'snackmeals', url: SNACKMEALS_URL, statusId: 'snackmeals-status-icon', name: 'snack meals' }
            ];

            const loadingTemplate = (menuType) => `<div class="loading"><i class="fa fa-spinner fa-spin"></i> Loading ${menuType} menu from IRCTC...</div>`;

            for (const tab of tabs) {
                const contentDiv = document.getElementById(tab.id);
                contentDiv.innerHTML = loadingTemplate(tab.name);
                
                // 1. Fetch Header Info (Using Proxy)
                const headerInfo = await fetchLastModifiedHeader(tab.url);
                const headerInfoBox = createHeaderInfoBox(headerInfo);

                // 2. Fetch Menu Content (Using Proxy)
                const menuData = await fetchMenuData(tab.url);
                const isOnline = menuData && Object.keys(menuData).length > 0;
                updateStatusIcon(tab.statusId, isOnline);

                // 3. Display Content
                if (isOnline) {
                    const menuContent = createMenuTable(menuData, tab.id);
                    contentDiv.innerHTML = headerInfoBox + menuContent;
                } else {
                    contentDiv.innerHTML = headerInfoBox + `
                        <div class="error">
                            <strong><i class="material-icons">error</i> Connection Error:</strong>
                            Unable to load the standard ${tab.name} menu. The IRCTC source might be temporarily unavailable.
                        </div>
                    `;
                }
            }
        });
    </script>
</body>
</html>
